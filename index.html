<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSRadio</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
    button, input, select { margin-top: 0.5em; padding: 0.5em; width: 100%; }
    .row { display: flex; gap: 1em; }
    .col { flex: 1; }
    textarea { width: 100%; height: 200px; margin-top: 1em; font-family: monospace; }
  </style>
</head>
<body>
  <h1>SSRadio 控制台</h1>

  <div class="row">
    <button onclick="connectSerial()">连接串口</button>
    <button onclick="disconnectSerial()">断开串口</button>
  </div>
  <p id="status">串口状态：未连接</p>

  <h3>时间/日期</h3>
  <div class="row">
    <div class="col">
      <input id="timeInput" placeholder="HH:MM:SS">
      <button onclick="sendCmd(`set_time ${timeInput.value}`)">设置时间</button>
      <button onclick="sendCmd('get_time')">查询时间</button>
    </div>
    <div class="col">
      <input id="dateInput" placeholder="YYYY-MM-DD">
      <button onclick="sendCmd(`set_date ${dateInput.value}`)">设置日期</button>
      <button onclick="sendCmd('get_date')">查询日期</button>
    </div>
  </div>


  <h3>设备授权</h3>
  <input id="block16" placeholder="输入16字节的授权码HEX，如 00112233AABBCCDDEEFF112233445566">
  <button onclick="write16BytesToEEPROM()">写入授权码</button>

  <h3>系统操作</h3>
  <button onclick="sendCmd('reboot')">重启设备</button>

  <h3>串口输出</h3>
  <textarea id="terminal" readonly></textarea>

  <h2>开发人员选项</h2>
  <h4>直接操作EEPROM，涉及波段设置，请谨慎操作！</h4>
  <div class="row">
    <div class="col">
      <input id="eaddr" placeholder="地址 (0-8191)">
      <input id="eval" placeholder="值 (十进制)">
      <button onclick="sendCmd(`eeprom_write ${eaddr.value} ${eval.value}`)">写入 1 字节</button>
      <button onclick="sendCmd(`eeprom_read ${eaddr.value}`)">读取 1 字节</button>
    </div>
    <div class="col">
      <input id="elen" placeholder="长度 (<=32)">
      <input id="eblock" placeholder="HEX 数据，如 AABBCC">
      <button onclick="sendCmd(`eeprom_write_block ${eaddr.value} ${eblock.value}`)">写入块</button>
      <button onclick="sendCmd(`eeprom_read_block ${eaddr.value} ${elen.value}`)">读取块</button>
    </div>
  </div>



  <script>
    let port, reader, writer;

    async function connectSerial() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });
        const decoder = new TextDecoderStream();
        const encoder = new TextEncoderStream();

        port.readable.pipeTo(decoder.writable);
        reader = decoder.readable.getReader();

        encoder.readable.pipeTo(port.writable);
        writer = encoder.writable.getWriter();

        document.getElementById('status').textContent = '串口状态：已连接';
        listenSerial();
      } catch (e) {
        alert("串口连接失败：" + e);
      }
    }

    async function disconnectSerial() {
      try {
        if (reader) {
          await reader.cancel();
          reader.releaseLock();
          reader = null;
        }
        if (writer) {
          writer.releaseLock();
          writer = null;
        }
        if (port) {
          await port.close();
          port = null;
        }
        document.getElementById('status').textContent = '串口状态：未连接';
      } catch (e) {
        alert("断开串口失败：" + e);
      }
    }

    async function listenSerial() {
      const terminal = document.getElementById('terminal');
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        terminal.value += value;
        terminal.scrollTop = terminal.scrollHeight;
      }
    }

    async function sendCmd(cmd) {
      if (!writer) return alert("未连接串口！");
      await writer.write(cmd.trim() + '\n');
    }

    function write16BytesToEEPROM() {
      const hex = document.getElementById('block16').value.trim();
      if (hex.length !== 32) {
        alert("请输入 16 字节（32 个 HEX 字符）！");
        return;
      }
      sendCmd(`eeprom_write_block 100 ${hex}`);
    }
  </script>
</body>
</html>
